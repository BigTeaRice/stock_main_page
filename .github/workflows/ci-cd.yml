name: Stock Analysis CI/CD

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 8 * * 1-5'  # 工作日早上8点运行（股市开盘前）
  workflow_dispatch:  # 手动触发
    inputs:
      analysis_type:
        description: '分析类型 (daily, weekly, custom)'
        required: false
        default: 'daily'

env:
  TA_LIB_VERSION: '0.4.0'
  PYTHON_VERSION: '3.9'

jobs:
  # 安装 TA-Lib 和依赖
  setup-environment:
    runs-on: ubuntu-latest
    outputs:
      ta-lib-dir: ${{ steps.install-ta-lib.outputs.ta-lib-dir }}
      python-version: ${{ steps.setup-python.outputs.python-version }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      id: setup-python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential autoconf automake libtool wget curl
        
    - name: Install TA-Lib
      id: install-ta-lib
      run: |
        chmod +x scripts/install_ta_lib.sh
        ./scripts/install_ta_lib.sh --version ${{ env.TA_LIB_VERSION }} --output /tmp/ta-lib
        echo "ta-lib-dir=/tmp/ta-lib" >> $GITHUB_OUTPUT
        
    - name: Set up environment variables
      run: |
        echo "TA_LIB_DIR=/tmp/ta-lib" >> $GITHUB_ENV
        echo "LD_LIBRARY_PATH=/tmp/ta-lib/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV
        echo "PKG_CONFIG_PATH=/tmp/ta-lib/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV

  # 测试和分析
  test-and-analyze:
    needs: setup-environment
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: Set TA-Lib environment
      run: |
        echo "TA_LIB_DIR=/tmp/ta-lib" >> $GITHUB_ENV
        echo "LD_LIBRARY_PATH=/tmp/ta-lib/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov matplotlib
        
    - name: Run tests
      run: |
        python -m pytest tests/ -v --cov=src --cov-report=xml
        
    - name: Run basic analysis
      run: |
        python src/main.py --symbol AAPL --days 30 --test-mode
        
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

  # 生成分析报告
  generate-report:
    needs: test-and-analyze
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Set TA-Lib environment
      run: |
        echo "TA_LIB_DIR=/tmp/ta-lib" >> $GITHUB_ENV
        echo "LD_LIBRARY_PATH=/tmp/ta-lib/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV
        
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install matplotlib seaborn plotly
        
    - name: Generate analysis report
      run: |
        python src/main.py --symbol AAPL --symbol MSFT --symbol GOOGL --days 90 --output report.html
        python src/main.py --sector technology --days 30 --output sector_report.html
        
    - name: Upload analysis report
      uses: actions/upload-artifact@v4
      with:
        name: stock-analysis-report
        path: |
          *.html
          *.png
        retention-days: 7

  # 安全扫描
  security-scan:
    needs: setup-environment
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Run security scan
      uses: pyupio/safety@latest
      with:
        api-key: ${{ secrets.SAFETY_API_KEY }}
        continue-on-error: true
        
    - name: Bandit security linting
      run: |
        pip install bandit
        bandit -r src/ -f html -o security-report.html || true
        
    - name: Upload security report
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: |
          security-report.html
        retention-days: 30
