name: Stock Analysis CI/CD

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      analysis_type:
        description: '分析类型'
        required: false
        default: 'daily'

env:
  TA_LIB_VERSION: '0.4.0'
  PYTHON_VERSION: '3.9'

jobs:
  setup-environment:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Create scripts directory
      run: |
        mkdir -p scripts
        ls -la
        
    - name: Create TA-Lib installation script
      run: |
        cat > scripts/install_ta_lib.sh << 'EOF'
        # 这里放置上面创建的完整 install_ta_lib.sh 脚本内容
        # 由于长度限制，实际使用时需要将完整脚本内容粘贴到这里
        EOF
        
    - name: Make script executable
      run: chmod +x scripts/install_ta_lib.sh
      
    - name: Verify script exists
      run: |
        ls -la scripts/
        [ -f scripts/install_ta_lib.sh ] && echo "✅ 脚本存在" || echo "❌ 脚本不存在"
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential autoconf automake libtool wget curl git
        
    - name: Install TA-Lib
      id: install-ta-lib
      run: |
        ./scripts/install_ta_lib.sh --version ${{ env.TA_LIB_VERSION }} --output /tmp/ta-lib
        
    - name: Verify TA-Lib installation
      run: |
        echo "检查安装目录:"
        ls -la /tmp/ta-lib/
        echo "检查库文件:"
        find /tmp/ta-lib -name "*.so" -o -name "*.a" | head -10
        [ -f /tmp/ta-lib/lib/libta_lib.so ] && echo "✅ TA-Lib 安装成功" || echo "❌ TA-Lib 安装失败"
        
    - name: Set environment variables
      run: |
        echo "TA_LIB_DIR=/tmp/ta-lib" >> $GITHUB_ENV
        echo "LD_LIBRARY_PATH=/tmp/ta-lib/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV
        echo "PKG_CONFIG_PATH=/tmp/ta-lib/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV

  test-python:
    needs: setup-environment
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10']
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Set TA-Lib environment
      run: |
        echo "TA_LIB_DIR=/tmp/ta-lib" >> $GITHUB_ENV
        echo "LD_LIBRARY_PATH=/tmp/ta-lib/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install yfinance pandas numpy matplotlib seaborn plotly pytest
        
    - name: Test TA-Lib Python binding
      run: |
        # 首先尝试安装 TA-Lib Python 绑定
        pip install TA-Lib || echo "TA-Lib Python 绑定安装失败，继续测试..."
        
        # 测试基本Python环境
        python -c "import pandas as pd; import numpy as np; print('✅ Pandas 和 Numpy 可用')"
        
        # 尝试导入 TA-Lib
        python -c "
        try:
            import talib
            print('✅ TA-Lib Python 绑定可用')
            print('TA-Lib 版本:', talib.__version__)
            print('函数数量:', len(talib.get_functions()))
        except ImportError as e:
            print('⚠ TA-Lib Python 绑定不可用:', e)
        except Exception as e:
            print('⚠ TA-Lib 测试出错:', e)
        "
        
    - name: Run basic tests
      run: |
        # 创建简单的测试文件
        cat > test_basic.py << 'EOF'
        import sys
        import os
        sys.path.append(os.path.join(os.getcwd(), 'src'))
        
        try:
            from data_fetcher import DataFetcher
            print("✅ 数据获取模块导入成功")
        except ImportError as e:
            print("❌ 数据获取模块导入失败:", e)
            
        try:
            import pandas as pd
            import numpy as np
            # 创建测试数据
            dates = pd.date_range('2023-01-01', periods=10)
            data = pd.DataFrame({
                'Open': np.random.rand(10) * 100 + 100,
                'High': np.random.rand(10) * 100 + 105,
                'Low': np.random.rand(10) * 100 + 95,
                'Close': np.random.rand(10) * 100 + 100,
                'Volume': np.random.randint(1000000, 10000000, 10)
            }, index=dates)
            print("✅ 测试数据创建成功")
        except Exception as e:
            print("❌ 测试数据创建失败:", e)
        EOF
        
        python test_basic.py

  security-scan:
    needs: setup-environment
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Security scan with Bandit
      run: |
        pip install bandit
        bandit -r src/ -f json -o security-report.json || true
        
    - name: Upload security report
      uses: actions/upload-artifact@v4
      with:
        name: security-report-${{ github.run_number }}
        path: security-report.json
